{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Mappings" : {
      "NatRegionMap" : {
        "us-east-1"      : { "AMI" : "ami-184dc970" }, {# AMI from 2014, update when required #}
        "us-west-1"      : { "AMI" : "ami-a98396ec" }, {# AMI from 2014, update when required #}
        "us-west-2"      : { "AMI" : "ami-290f4119" }, {# AMI from 2014, update when required #}
        "eu-west-1"      : { "AMI" : "ami-a8dd45db" }, {# AMI from 2016, amzn-ami-vpc-nat-hvm-2016.03.3.x86_64-ebs, update when required #}
        "eu-central-1"   : { "AMI" : "ami-5825cd37" }, {# AMI from 2016, amzn-ami-vpc-nat-hvm-2016.03.3.x86_64-ebs, update when required #}
        "sa-east-1"      : { "AMI" : "ami-8122969c" }, {# AMI from 2014, update when required #}
        "ap-southeast-1" : { "AMI" : "ami-6aa38238" }, {# AMI from 2014, update when required #}
        "ap-southeast-2" : { "AMI" : "ami-893f53b3" }, {# AMI from 2014, update when required #}
        "ap-northeast-1" : { "AMI" : "ami-27d6e626" }  {# AMI from 2014, update when required #}
      }
  },
  "Resources": {
       "SecurityGroupNAT{{ nat.id }}"                            : {
              "Type" : "AWS::EC2::SecurityGroup",
              "Properties" : {
                  "VpcId" : "{{ network_id }}",
                  "GroupDescription" : "Firewalling for NAT",
                  "Tags"                 : [
                      {
                          "Key" : "Name",
                          "Value" : "SecurityGroupNAT{{ nat.id }}"
                      }
                  ]
              }
          },

    "NAT" : {
      "Type" : "AWS::EC2::Instance",
      "Properties" : {
        "InstanceType" : "{{ nat.type }}",
        "KeyName"  : "{{ nat.key_pair }}",
        "SourceDestCheck" : "false",
        "ImageId" : { "Fn::FindInMap" : [ "NatRegionMap", { "Ref" : "AWS::Region" }, "AMI" ]},
    "NetworkInterfaces" : [{
	      {% if nat.firewall is defined %}
          "GroupSet"                 : [{ "Ref" : "SecurityGroupNAT{{ nat.id }}" }],
          {% endif %}
          "AssociatePublicIpAddress" : "true",
          "DeviceIndex"              : "0",
          "DeleteOnTermination"      : "true",
          "SubnetId"                 : "{{ subnet_id }}"
        }],
	"Tags" : [
	  { "Key" : "Name", "Value" : "{{ nat.name }}" }
        ],
	"UserData" : { "Fn::Base64" : { "Fn::Join" : ["", [
	  "#!/bin/bash\n",
	  "yum update -y && yum install -y yum-cron && chkconfig yum-cron on"
	]]}}
      }
    },

    {% for routing_key, routing_id in routing_ids.items() %}
        "NATRoute{{ routing_key }}": {
           "Type" : "AWS::EC2::Route",
           "Properties" : {
              "RouteTableId" : "{{ routing_id }}",
              "DestinationCidrBlock" : "0.0.0.0/0",
              "InstanceId" : {"Ref": "NAT"}
           }
        }{% if not loop.last %},{% endif %}

    {% endfor %}


  }
}
